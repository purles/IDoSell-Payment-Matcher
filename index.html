<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDoSell Payment Matcher - Mapowanie wp≈Çat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Papa/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4E3261 0%, #6B4C7A 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #F3E8E1;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4E3261 0%, #6B4C7A 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4E3261;
        }

        .upload-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 2px dashed #4E3261;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fff9f5;
        }

        .upload-box:hover {
            border-color: #6B4C7A;
            background: #f5f0eb;
            transform: translateY(-2px);
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-box label {
            cursor: pointer;
            display: block;
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .upload-box h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }

        .upload-box p {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .file-name {
            font-size: 12px;
            color: #4E3261;
            font-weight: bold;
            margin-top: 10px;
            min-height: 20px;
        }

        button {
            background: linear-gradient(135deg, #4E3261 0%, #6B4C7A 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 50, 97, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert ul, .alert ol {
            margin: 10px 0 0 20px;
        }

        .alert li {
            margin-bottom: 5px;
        }

        .results-section {
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .results-table thead {
            background: #667eea;
            color: white;
            position: sticky;
            top: 0;
        }

        .results-table th {
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #764ba2;
        }

        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        .results-table tbody tr:hover {
            background: #fff9f5;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .order-link {
            color: #4E3261;
            text-decoration: none;
            font-weight: bold;
        }

        .order-link:hover {
            text-decoration: underline;
        }

        .order-items {
            max-height: 200px;
            overflow-y: auto;
            background: #fff9f5;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .order-item {
            padding: 4px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .discrepancy {
            color: #721c24;
            font-weight: bold;
        }

        .negative-discrepancy {
            color: #fff;
            background: #721c24;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .summary-box {
            background: #fff9f5;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .summary-box h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat {
            padding: 10px;
            background: #F3E8E1;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #4E3261;
            margin-top: 5px;
        }

        .footer {
            background: #fff9f5;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #ddd;
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .results-table {
                font-size: 11px;
            }

            .results-table th, .results-table td {
                padding: 8px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s ease-in;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: #F3E8E1;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h2 {
            margin: 0 0 20px 0;
            font-size: 24px;
        }

        .modal-content .modal-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .modal-content p {
            margin: 10px 0;
            font-size: 16px;
            line-height: 1.6;
        }

        .modal-content .modal-stats {
            background: #fff9f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #4E3261;
        }

        .modal-content .modal-stat-item {
            margin: 10px 0;
            font-size: 14px;
        }

        .modal-content button {
            margin-top: 20px;
            padding: 12px 40px;
            font-size: 16px;
        }
    </style>
</head>
<body>
            <div id="summaryModal" class="modal">
            <div class="modal-content">
                <div class="modal-icon" id="modalIcon">‚úÖ</div>
                <h2 id="modalTitle">Parsowanie zako≈Ñczone!</h2>
                <div class="modal-stats" id="modalStats"></div>
                <p id="modalMessage"></p>
                <button onclick="closeSummaryModal()">Dalej ‚Üí</button>
            </div>
        </div>

    <div class="container">
        <div class="header">
            <h1>üìä IDoSell Payment Matcher</h1>
            <p>Mapowanie wp≈Çat od klient√≥w do cotygodniowych transz wyp≈Çat</p>
        </div>

        <div class="content">
            <!-- SEKCJA UPLOADU -->
            <div class="section">
                <h2>1Ô∏è‚É£ Za≈Çaduj pliki</h2>
                
                <div class="upload-container">
                    <div class="upload-box">
                        <label for="payoutFile">
                            <div class="upload-icon">üí∞</div>
                            <h3>Wyp≈Çaty do nas</h3>
                            <p>Cotygodniowe transze</p>
                            <input type="file" id="payoutFile" accept=".ods,.xlsx,.xls,.csv">
                            <div class="file-name" id="payoutFileName"></div>
                        </label>
                    </div>

                    <div class="upload-box">
                        <label for="blikFile">
                            <div class="upload-icon">üì±</div>
                            <h3>BLIK IdoPay</h3>
                            <p>Wp≈Çaty BLIK od klient√≥w</p>
                            <input type="file" id="blikFile" accept=".ods,.xlsx,.xls,.csv">
                            <div class="file-name" id="blikFileName"></div>
                        </label>
                    </div>

                    <div class="upload-box">
                        <label for="paybyFile">
                            <div class="upload-icon">üí≥</div>
                            <h3>PayByLink IdoPay</h3>
                            <p>Wp≈Çaty szybkie przelewami</p>
                            <input type="file" id="paybyFile" accept=".ods,.xlsx,.xls,.csv">
                            <div class="file-name" id="paybyFileName"></div>
                        </label>
                    </div>

                    <div class="upload-box">
                        <label for="ordersFile">
                            <div class="upload-icon">üìã</div>
                            <h3>Zam√≥wienia (klienci)</h3>
                            <p>Export zam√≥wie≈Ñ z danymi klient√≥w</p>
                            <input type="file" id="ordersFile" accept=".csv">
                            <div class="file-name" id="ordersFileName"></div>
                        </label>
                    </div>
                </div>

                <div class="button-group">
                    <button onclick="processFiles()">‚ñ∂Ô∏è Przetw√≥rz pliki</button>
                    <button onclick="clearAll()">üîÑ Wyczy≈õƒá</button>
                </div>

                <div id="loadingIndicator" class="loading">
                    <div class="spinner"></div>
                    <p>Przetwarzanie plik√≥w...</p>
                </div>

                <div id="alertContainer"></div>
            </div>

            <!-- SEKCJA WYNIK√ìW -->
            <div class="section results-section" id="resultsSection">
                <h2>2Ô∏è‚É£ Wyniki mapowania</h2>

                <div id="summaryBox" class="summary-box">
                    <h3>üìà Podsumowanie</h3>
                    <div class="summary-stats" id="summaryStats"></div>
                </div>

                <div class="button-group">
                    <button onclick="exportToCSV()">üì• Pobierz CSV</button>
                    <button onclick="exportToODS()">üì• Pobierz ODS</button>
                    <button onclick="printResults()">üñ®Ô∏è Drukuj</button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="results-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Data transzy (zaksiƒôgowania)</th>
                                <th>ID transzy</th>
                                <th>Kwota transzy (z≈Ç)</th>
                                <th>Wp≈Çaty od klient√≥w</th>
                                <th>Data p≈Çatno≈õci</th>
                                <th>Klient</th>
                                <th>Kwota wp≈Çat (z≈Ç)</th>
                                <th>Prowizje (z≈Ç)</th>
                                <th>R√≥≈ºnica (z≈Ç)</th>
                                <th>Uwagi</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="issuesContainer"></div>
            </div>
        </div>

        <div class="footer">
            ‚ÑπÔ∏è Narzƒôdzie przetwarzajƒÖcy dane lokalnie w przeglƒÖdarce ‚Ä¢ Brak przesy≈Çania danych na serwer
        </div>
    </div>

    <script>
        // ===== ZMIENNE GLOBALNE =====
        let parsedData = {
            payouts: [],
            blik: [],
            payby: []
        };
        let ordersData = {};
        let lastResults = null;

        
        // ===== DETEKCJA MIESIƒòCY =====
        function detectMonths() {
            const months = new Set();
            
            // Zbieraj miesiƒÖce z transz
            parsedData.payouts.forEach(p => {
                if (p.dateAdded) {
                    const monthKey = p.dateAdded.getFullYear() + '-' + String(p.dateAdded.getMonth() + 1).padStart(2, '0');
                    months.add(monthKey);
                }
            });
            
            // Zbieraj miesiƒÖce z wp≈Çat
            [...parsedData.blik, ...parsedData.payby].forEach(p => {
                if (p.dateBooked) {
                    const monthKey = p.dateBooked.getFullYear() + '-' + String(p.dateBooked.getMonth() + 1).padStart(2, '0');
                    months.add(monthKey);
                }
            });
            
            const sortedMonths = Array.from(months).sort().reverse();
            console.log('MiesiƒÖce w plikach:', sortedMonths);
            return sortedMonths;
        }

        // ===== SELEKTOR MIESIƒòCY =====
        function showMonthSelector(months) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '';
            
            const monthNames = {
                '01': 'Stycze≈Ñ', '02': 'Luty', '03': 'Marzec', '04': 'Kwiecie≈Ñ',
                '05': 'Maj', '06': 'Czerwiec', '07': 'Lipiec', '08': 'Sierpie≈Ñ',
                '09': 'Wrzesie≈Ñ', '10': 'Pa≈∫dziernik', '11': 'Listopad', '12': 'Grudzie≈Ñ'
            };
            
            const alert = document.createElement('div');
            alert.className = 'alert alert-info show';
            
            let html = `<strong>üìÖ Wybierz miesiƒÖc do rozliczenia:</strong><br><div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">`;
            
            months.forEach(month => {
                const [year, monthNum] = month.split('-');
                const monthName = monthNames[monthNum] || 'Nieznany';
                const displayText = `${monthName} ${year}`;
                
                html += `<button onclick="filterByMonth('${month}')" style="padding: 10px 20px;">${displayText}</button>`;
            });
            
            html += `</div>`;
            alert.innerHTML = html;
            alertContainer.appendChild(alert);
            
            console.log('Selektor miesiƒôcy wy≈õwietlony dla:', months);
        }

        function filterByMonth(selectedMonth) {
            console.log('Filtrowanie dla miesiƒÖca:', selectedMonth);
            
            const [year, month] = selectedMonth.split('-');
            const selectedMonthDate = new Date(year, parseInt(month) - 1, 1);
            const endDate = new Date(year, parseInt(month), 0, 23, 59, 59);
            
            // Znajd≈∫ transze w wybranym miesiƒÖcu
            const payoutsInMonth = parsedData.payouts.filter(p => {
                return p.dateAdded >= selectedMonthDate && p.dateAdded <= endDate;
            });
            
            console.log(`Transze w miesiƒÖcu: ${payoutsInMonth.length}`);
            
            // Punkt startowy: ostatnia transza sprzed wybranego miesiƒÖca
            let periodStartPayment = new Date(2000, 0, 1); // Default - od poczƒÖtku
            
            const payoutsBeforeMonth = parsedData.payouts.filter(p => {
                return p.dateAdded < selectedMonthDate;
            });
            
            if (payoutsBeforeMonth.length > 0) {
                // Sortuj po dacie dodania, aby znale≈∫ƒá ostatniƒÖ transszƒô
                const sortedBefore = payoutsBeforeMonth.sort((a, b) => b.dateAdded - a.dateAdded);
                periodStartPayment = sortedBefore[0].dateAdded; // Ostatnia transza sprzed miesiƒÖca
                console.log(`Punkt startowy (ostatnia transza poprzedniego miesiƒÖca): ${formatDate(periodStartPayment)}`);
            }
            
            // Filtruj transze - bierz z wybranego miesiƒÖca
            const filteredPayouts = payoutsInMonth;
            
            // Filtruj wp≈Çaty - od ostatniej transzy poprzedniego miesiƒÖca (exclusive) do konca wybranego miesiƒÖca (inclusive)
            const filteredBlik = parsedData.blik.filter(p => {
                return p.dateBooked > periodStartPayment && p.dateBooked <= endDate;
            });
            
            const filteredPayby = parsedData.payby.filter(p => {
                return p.dateBooked > periodStartPayment && p.dateBooked <= endDate;
            });
            
            console.log(`Filtrowane wp≈Çaty: ${filteredBlik.length} BLIK + ${filteredPayby.length} PayByLink`);
            
            // Tymczasowo zastƒÖp dane
            const originalPayouts = parsedData.payouts;
            const originalBlik = parsedData.blik;
            const originalPayby = parsedData.payby;
            
            parsedData.payouts = filteredPayouts;
            parsedData.blik = filteredBlik;
            parsedData.payby = filteredPayby;
            
            // Mapowanie i wy≈õwietlanie
            const results = mapPayments();
            displayResults(results);
            
            // Przywr√≥ƒá oryginalne dane
            parsedData.payouts = originalPayouts;
            parsedData.blik = originalBlik;
            parsedData.payby = originalPayby;
            
            document.getElementById('resultsSection').classList.add('show');
            
            // Scroll do wynik√≥w
            setTimeout(() => {
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // ===== OBS≈ÅUGA UPLOADU =====
        document.getElementById('payoutFile').addEventListener('change', function(e) {
            updateFileName('payoutFileName', this.files[0]);
        });

        document.getElementById('blikFile').addEventListener('change', function(e) {
            updateFileName('blikFileName', this.files[0]);
        });

        document.getElementById('paybyFile').addEventListener('change', function(e) {
            updateFileName('paybyFileName', this.files[0]);
        });

        document.getElementById('ordersFile').addEventListener('change', function(e) {
            updateFileName('ordersFileName', this.files[0]);
        });

        function updateFileName(elementId, file) {
            if (file) {
                document.getElementById(elementId).textContent = '‚úÖ ' + file.name;
            }
        }


        // ===== PARSOWANIE ZAM√ìWIE≈É =====
        function parseOrders(csvData) {
            const orders = {};
            
            // csvData mo≈ºe byƒá array lub string
            let lines;
            if (Array.isArray(csvData)) {
                // Je≈õli to array - to ju≈º sparsowany CSV
                lines = csvData;
            } else if (typeof csvData === 'string') {
                // Je≈õli to string - parsuj go
                lines = csvData.split('\n');
            } else {
                console.error('B≈Çƒôdny format danych zam√≥wie≈Ñ');
                return orders;
            }
            
            if (lines.length < 2) {
                console.log('Brak danych w pliku zam√≥wie≈Ñ');
                return orders;
            }
            
            // Czytanie nag≈Ç√≥wk√≥w
            const headerLine = Array.isArray(lines[0]) ? lines[0] : parseCSVLine(lines[0]);
            const headers = headerLine.map(h => String(h).trim().replace(/^"|"$/g, ''));
            console.log('Nag≈Ç√≥wki zam√≥wie≈Ñ:', headers);
            
            // Indeksy kolumn
            const orderNumIdx = headers.indexOf('Nr zam√≥wienia');
            const firstNameIdx = headers.indexOf('Biling-Imiƒô');
            const lastNameIdx = headers.indexOf('Biling-Nazwisko');
            const companyIdx = headers.indexOf('Biling-Nazwa firmy');
            
            if (orderNumIdx === -1) {
                console.error('Nie znaleziono kolumny "Nr zam√≥wienia"');
                console.log('Dostƒôpne kolumny:', headers);
                return orders;
            }
            
            console.log(`Kolumny: OrderNum=${orderNumIdx}, FirstName=${firstNameIdx}, LastName=${lastNameIdx}, Company=${companyIdx}`);
            
            // Parsowanie wierszy
            for (let i = 1; i < lines.length; i++) {
                let cells;
                
                if (Array.isArray(lines[i])) {
                    cells = lines[i].map(c => String(c || '').trim());
                } else {
                    if (!lines[i].trim()) continue;
                    cells = parseCSVLine(lines[i]);
                }
                
                if (cells.length > orderNumIdx) {
                    const orderNum = cells[orderNumIdx].trim();
                    if (orderNum && !isNaN(orderNum)) {
                        const firstName = firstNameIdx >= 0 ? cells[firstNameIdx].trim() : '';
                        const lastName = lastNameIdx >= 0 ? cells[lastNameIdx].trim() : '';
                        const company = companyIdx >= 0 ? cells[companyIdx].trim() : '';
                        
                        // Nazwisko klienta
                        let clientName = firstName + ' ' + lastName;
                        if (company && company !== '') {
                            clientName = company;
                        }
                        
                        orders[parseInt(orderNum)] = {
                            firstName: firstName,
                            lastName: lastName,
                            company: company,
                            fullName: clientName.trim()
                        };
                    }
                }
            }
            
            console.log(`‚úì Za≈Çadowano ${Object.keys(orders).length} zam√≥wie≈Ñ`);
            return orders;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ';' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }


                // ===== CZYTANIE PLIK√ìW =====
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let data;
                        const fileName = file.name.toLowerCase();
                        
                        if (fileName.endsWith('.ods')) {
                            // Obs≈Çuga ODS - czytaj jako binarny i parsuj z XLSX
                            const workbook = XLSX.read(e.target.result, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                            console.log(`Plik ${fileName}: ${data.length} wierszy`);
                            resolve(data);
                        } else if (fileName.endsWith('.csv')) {
                            // Obs≈Çuga CSV - w≈Çasny parser
                            const text = e.target.result;
                            const lines = text.split('\n');
                            data = [];
                            
                            lines.forEach(line => {
                                if (line.trim()) {
                                    // Parsowanie CSV z cudzys≈Çowami i ≈õrednikami
                                    const cells = parseCSVLine(line);
                                    data.push(cells);
                                }
                            });
                            
                            console.log(`Plik ${fileName}: ${data.length} wierszy`);
                            resolve(data);
                        } else {
                            // Obs≈Çuga XLSX/XLS
                            const workbook = XLSX.read(e.target.result, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                            console.log(`Plik ${fileName}: ${data.length} wierszy`);
                            resolve(data);
                        }
                    } catch (error) {
                        console.error('B≈ÇƒÖd readFile:', error);
                        reject(error);
                    }
                };
                
                reader.onerror = function(error) {
                    reject(error);
                };
                
                // Obs≈Çuga binarnych dla XLSX/ODS, text dla CSV
                if (file.name.toLowerCase().endsWith('.csv')) {
                    reader.readAsText(file, 'UTF-8');
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        // ===== PARSOWANIE DANYCH =====
        async function processFiles() {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '';

            const payoutFile = document.getElementById('payoutFile').files[0];
            const blikFile = document.getElementById('blikFile').files[0];
            const paybyFile = document.getElementById('paybyFile').files[0];
            const ordersFile = document.getElementById('ordersFile').files[0];

            if (!payoutFile || !blikFile || !paybyFile) {
                showAlert('B≈ÇƒÖd', 'Musisz za≈Çadowaƒá pliki: Transze, BLIK i PayByLink!', 'error');
                return;
            }

            if (!ordersFile) {
                showAlert('Ostrze≈ºenie', 'Plik zam√≥wie≈Ñ nie zosta≈Ç za≈Çadowany. Dane klient√≥w nie bƒôdƒÖ dostƒôpne.', 'warning');
            }

            document.getElementById('loadingIndicator').style.display = 'block';

            try {
                const payoutData = await readFile(payoutFile);
                const blikData = await readFile(blikFile);
                const paybyData = await readFile(paybyFile);

                // Parsowanie danych
                parsedData.payouts = parsePayouts(payoutData);
                parsedData.blik = parsePayments(blikData, 'BLIK');
                parsedData.payby = parsePayments(paybyData, 'PayByLink');
                
                // Parsowanie zam√≥wie≈Ñ je≈õli zosta≈Ç za≈Çadowany
                if (ordersFile) {
                    const ordersCSVData = await readFile(ordersFile);
                    ordersData = parseOrders(ordersCSVData);
                }

                // Walidacja
                const validationResults = validateData();
                
                if (validationResults.errors.length > 0) {
                    validationResults.errors.forEach(error => {
                        showAlert('B≈ÇƒÖd krityczny', error, 'error');
                    });
                    document.getElementById('loadingIndicator').style.display = 'none';
                    return;
                }

                if (validationResults.warnings.length > 0) {
                    validationResults.warnings.forEach(warning => {
                        showAlert('Ostrze≈ºenie', warning, 'warning');
                    });
                }

                // Detekcja miesiƒôcy w plikach
                const months = detectMonths();
                
                if (months.length > 1) {
                    // Je≈õli wiƒôcej ni≈º jeden miesiƒÖc - poka≈º selektor
                    document.getElementById('loadingIndicator').style.display = 'none';
                    showMonthSelector(months);
                } else {
                    // Je≈õli jeden miesiƒÖc - przetwarzaj normalnie
                    const results = mapPayments();
                    displayResults(results);
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('resultsSection').classList.add('show');
                }

            } catch (error) {
                console.error(error);
                showAlert('B≈ÇƒÖd', 'Nie uda≈Ço siƒô przeczytaƒá pliku: ' + error.message, 'error');
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function parsePayouts(rawData) {
            console.log('=== PARSEOWANIE PAYOUTS ===');
            console.log(`Surowe dane: ${rawData.length} wierszy`);
            
            // Nag≈Ç√≥wek jest w wierszu 3 (indeks 3)
            let headerRowIndex = 3;
            
            // Szukam wiersza nag≈Ç√≥wka - zabezpieczenie
            for (let i = 0; i < Math.min(rawData.length, 15); i++) {
                const firstCell = String(rawData[i]?.[0] || '').trim();
                if (firstCell.includes('Numer zam√≥wienia')) {
                    headerRowIndex = i;
                    console.log(`Header znaleziony w wierszu ${i}`);
                    break;
                }
            }

            const dataRows = rawData.slice(headerRowIndex + 1);
            console.log(`Dane do przetworzenia: ${dataRows.length} wierszy`);

            const payouts = [];
            
            // Szukam wierszy "Wyp≈Çata ≈õrodk√≥w IdoPay na konto"
            for (let idx = 0; idx < dataRows.length; idx++) {
                const row = dataRows[idx];
                if (!row || row.length === 0) continue;
                
                const typ = String(row[6] || '').trim();
                
                // Je≈õli to transza
                if (typ.includes('Wyp≈Çata ≈õrodk√≥w IdoPay na konto')) {
                    const dateAddedStr = String(row[7] || '').trim();
                    const dateBookedStr = String(row[8] || '').trim();
                    const amount = Math.abs(parseFloat(String(row[2] || '0').replace(',', '.')));
                    
                    // Szukam prowizji za tƒô transszƒô - bƒôdzie w wierszu przed
                    let provision = 0;
                    if (idx > 0 && idx < dataRows.length) {
                        const prevRow = dataRows[idx - 1];
                        if (prevRow && String(prevRow[6] || '').includes('Prowizja za wyp≈Çatƒô')) {
                            provision = Math.abs(parseFloat(String(prevRow[2] || '0').replace(',', '.')));
                            console.log(`Znaleziona prowizja za transszƒô: ${provision} z≈Ç`);
                        }
                    }
                    
                    const parsed = {
                        dateAdded: parseDate(dateAddedStr),
                        dateBooked: parseDate(dateBookedStr),
                        amount: amount + provision, // Kwota NETTO bez prowizji
                        transactionId: String(row[1] || ''),
                        paymentId: String(row[11] || ''),
                        provision: provision,
                        rowData: row
                    };

                    if (parsed.dateBooked && !isNaN(parsed.dateBooked.getTime())) {
                        payouts.push(parsed);
                        console.log(`‚úì Transza: ${parsed.paymentId} | ${dateBookedStr} | ${amount} z≈Ç + ${provision} z≈Ç prowizji`);
                    }
                }
            }

            console.log(`‚úÖ Za≈Çadowano ${payouts.length} transz (z prowizjami)`);
            return payouts;
        }

        function parsePayments(rawData, type) {
            console.log(`=== PARSEOWANIE PAYMENTS (${type}) ===`);
            console.log(`Surowe dane: ${rawData.length} wierszy`);
            
            // Szukam wiersza nag≈Ç√≥wka
            let headerRowIndex = 2;
            for (let i = 0; i < Math.min(rawData.length, 15); i++) {
                const firstCell = String(rawData[i]?.[0] || '').trim();
                if (firstCell.includes('Numer zam√≥wienia')) {
                    headerRowIndex = i;
                    console.log(`Header znaleziony w wierszu ${i}`);
                    break;
                }
            }

            const dataRows = rawData.slice(headerRowIndex + 1);
            console.log(`Dane do przetworzenia: ${dataRows.length} wierszy`);

            const filtered = dataRows
                .filter(row => {
                    if (!row || row.length === 0) return false;
                    const firstCol = String(row[0] || '').trim();
                    // Musi byƒá numerem zam√≥wienia (liczba)
                    return /^\d+$/.test(firstCol);
                })
                .map((row, idx) => {
                    const orderNumber = String(row[0] || '').trim();
                    const dateStr = String(row[8] || '').trim();
                    const amount = parseFloat(String(row[2] || '0').replace(',', '.'));
                    const commission = parseFloat(String(row[13] || '0').replace(',', '.'));
                    const transactionId = String(row[1] || '');
                    
                    if (idx < 3 || idx % 30 === 0) {
                        console.log(`Wp≈Çata ${idx}: #${orderNumber} | ${dateStr} | ${amount} z≈Ç`);
                    }
                    
                    return {
                        orderNumber,
                        transactionId,
                        dateBooked: parseDate(dateStr),
                        amount,
                        commission,
                        type,
                        rowData: row
                    };
                })
                .filter(p => {
                    const valid = p.dateBooked && !isNaN(p.dateBooked.getTime()) && p.orderNumber;
                    if (!valid) {
                        console.log(`‚ùå Filtrowana (${type}): ${p.orderNumber} - ${p.dateBooked}`);
                    }
                    return valid;
                });

            console.log(`‚úÖ Za≈Çadowano ${filtered.length} wp≈Çat (${type})`);
            return filtered;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Pr√≥ba parsowania jako data ISO
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
                return date;
            }
            
            // Pr√≥ba parsowania polskiego formatu
            const match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})/);
            if (match) {
                return new Date(match[1], parseInt(match[2]) - 1, match[3], match[4], match[5]);
            }
            
            return null;
        }

        // ===== WALIDACJA =====
        function validateData() {
            const errors = [];
            const warnings = [];

            if (parsedData.payouts.length === 0) {
                errors.push('Brak danych w pliku "Wyp≈Çaty do nas"');
            }
            if (parsedData.blik.length === 0 && parsedData.payby.length === 0) {
                errors.push('Brak danych w plikach z wp≈Çatami od klient√≥w');
            }

            // Sprawdzenie duplikat√≥w w wp≈Çatach
            const allPayments = [...parsedData.blik, ...parsedData.payby];
            const duplicateOrders = {};
            allPayments.forEach(p => {
                duplicateOrders[p.orderNumber] = (duplicateOrders[p.orderNumber] || 0) + 1;
            });

            Object.entries(duplicateOrders).forEach(([order, count]) => {
                if (count > 1) {
                    warnings.push(`Zam√≥wienie ${order} pojawia siƒô ${count} razy w plikach wp≈Çat`);
                }
            });

            // Sprawdzenie warto≈õci ujemnych (zwroty?)
            const negativePayments = allPayments.filter(p => p.amount < 0);
            if (negativePayments.length > 0) {
                warnings.push(`‚ö†Ô∏è Znaleziono ${negativePayments.length} wp≈Çat z ujemnymi kwotami (mo≈ºliwe zwroty)`);
            }

            return { errors, warnings };
        }

        // ===== MAPOWANIE WP≈ÅAT =====
        function mapPayments() {
            const allPayments = [...parsedData.blik, ...parsedData.payby];
            
            console.log('\n=== MAPOWANIE WP≈ÅAT ===');
            console.log(`Transze do mapowania: ${parsedData.payouts.length}`);
            console.log(`Wp≈Çaty BLIK: ${parsedData.blik.length}`);
            console.log(`Wp≈Çaty PayByLink: ${parsedData.payby.length}`);
            console.log(`Razem wp≈Çat: ${allPayments.length}`);

            // Sortujƒô transze od najstarszej do najnowszej (bo mogƒÖ byƒá w odwrotnym porzƒÖdku)
            // WA≈ªNE: Sortujƒô po Data DODANIA, nie zaksiƒôgowania!
            const sortedPayouts = [...parsedData.payouts].sort((a, b) => a.dateAdded - b.dateAdded);
            
            console.log('\nTransze (posortowane po Data Dodania):');
            sortedPayouts.forEach((p, i) => {
                console.log(`  ${i}: Dodana: ${formatDate(p.dateAdded)} | Zaksiƒôgowana: ${formatDate(p.dateBooked)} | ID: ${p.paymentId}`);
            });

            const results = [];

            sortedPayouts.forEach((payout, index) => {
                console.log(`\n--- Mapowanie transzy ${index} (Dodana: ${formatDate(payout.dateAdded)}) ---`);
                
                // Okres: od daty dodania poprzedniej transzy (exclusive) do daty dodania bie≈ºƒÖcej transzy (inclusive)
                let periodStart;
                let periodEnd = payout.dateAdded; // U≈ªYWAMY Data Dodania, nie zaksiƒôgowania!

                if (index === 0) {
                    // Dla pierwszej transzy - od poczƒÖtku czas√≥w
                    periodStart = new Date(2000, 0, 1);
                    console.log(`Pierwszy okres: od ${formatDate(periodStart)} do ${formatDate(periodEnd)}`);
                } else {
                    periodStart = sortedPayouts[index - 1].dateAdded; // POPRZEDNIA TRANSZA te≈º po Data Dodania!
                    console.log(`Okres: od ${formatDate(periodStart)} (excl) do ${formatDate(periodEnd)} (incl)`);
                }

                // Znalezienie wp≈Çat w danym oknie czasowym
                // WA≈ªNE: Wp≈Çaty mapujemy po Data Zaksiƒôgowania (kiedy faktycznie trafi≈Çy)
                const matchingPayments = allPayments.filter(p => {
                    const isMatch = p.dateBooked > periodStart && p.dateBooked <= periodEnd;
                    return isMatch;
                });

                console.log(`‚úì Znaleziono ${matchingPayments.length} wp≈Çat`);
                matchingPayments.slice(0, 5).forEach(p => {
                    console.log(`  - Zam√≥wienie ${p.orderNumber} (${p.type}): Zaksiƒôgowana: ${formatDate(p.dateBooked)} | ${p.amount} z≈Ç`);
                });
                if (matchingPayments.length > 5) {
                    console.log(`  ... i ${matchingPayments.length - 5} wiƒôcej`);
                }

                // Obliczenia
                // WA≈ªNE: Wp≈Çaty to kwoty brutto, ale transza to NETTO (po prowizjach)
                // Dlatego: Kwota netto = suma wp≈Çat - suma prowizji
                const totalAmount = matchingPayments.reduce((sum, p) => sum + p.amount, 0);
                const totalCommission = matchingPayments.reduce((sum, p) => sum + p.commission, 0);
                const totalNetAmount = totalAmount - totalCommission; // NETTO dla por√≥wnania z transszƒÖ
                
                const difference = payout.amount - totalNetAmount;

                // Status
                let status = 'ok';
                let issues = [];

                if (Math.abs(difference) > 0.01) { // tolerancja zaokrƒÖglenia
                    status = 'warning';
                    if (difference < 0) {
                        issues.push(`‚ö†Ô∏è UJEMNA R√ì≈ªNICA: IDoSell pobra≈Ç dodatkowe ${Math.abs(difference).toFixed(2)} z≈Ç`);
                    } else {
                        issues.push(`R√≥≈ºnica: +${difference.toFixed(2)} z≈Ç`);
                    }
                }

                if (matchingPayments.length === 0) {
                    status = 'warning';
                    issues.push('Brak powiƒÖzanych wp≈Çat od klient√≥w');
                }

                const negativePayments = matchingPayments.filter(p => p.amount < 0);
                if (negativePayments.length > 0) {
                    issues.push(`${negativePayments.length} ujemne kwoty (zwroty?)`);
                }

                console.log(`Status: ${status} | R√≥≈ºnica: ${difference.toFixed(2)} z≈Ç`);

                results.push({
                    payout,
                    matchingPayments,
                    status,
                    issues,
                    totalAmount,           // Brutto
                    totalCommission,       // Prowizje
                    totalNetAmount,        // Netto
                    difference
                });
            });

            console.log('\n=== KONIEC MAPOWANIA ===\n');
            return results;
        }

        // ===== WY≈öWIETLANIE WYNIK√ìW =====
        function displayResults(results) {
            lastResults = results;
            const tbody = document.getElementById('resultsTableBody');
            const summaryBox = document.getElementById('summaryStats');
            tbody.innerHTML = '';

            let totalPayouts = 0;
            let totalPaymentsBrutto = 0;
            let totalPaymentsNetto = 0;
            let totalDifferences = 0;
            let issuesCount = 0;

            results.forEach((result, idx) => {
                totalPayouts += result.payout.amount;
                totalPaymentsBrutto += result.totalAmount;
                totalPaymentsNetto += result.totalNetAmount;
                totalDifferences += result.difference;

                if (result.issues.length > 0) {
                    issuesCount++;
                }

                // Je≈õli sƒÖ zam√≥wienia - ka≈ºde w osobnym wierszu
                if (result.matchingPayments.length > 0) {
                    result.matchingPayments.forEach((payment, payIdx) => {
                        const row = document.createElement('tr');
                        
                        // Status i info o transzy tylko w pierwszym wierszu
                        const statusClass = `status-${result.status}`;
                        const isFirstPayment = payIdx === 0;
                        
                        // Zaznacz ca≈Çy wiersz je≈õli ujemna r√≥≈ºnica
                        const isNegativeDiff = result.difference < -0.01;
                        if (isNegativeDiff && isFirstPayment) {
                            row.style.background = '#fff3cd';
                            row.style.fontWeight = 'bold';
                        }
                        
                        // Dane klienta
                        const clientInfo = ordersData[payment.orderNumber];
                        const clientName = clientInfo ? clientInfo.fullName : '-';
                        
                        row.innerHTML = `
                            <td>${isFirstPayment ? `<span class="status-badge ${statusClass}">${result.status === 'ok' ? '‚úÖ OK' : result.status === 'warning' ? '‚ö†Ô∏è UWAGA' : '‚ùå B≈ÅƒÑD'}</span>` : ''}</td>
                            <td>${isFirstPayment ? formatDate(result.payout.dateBooked) : ''}</td>
                            <td>${isFirstPayment ? result.payout.paymentId : ''}</td>
                            <td class="text-right">${isFirstPayment ? result.payout.amount.toFixed(2) : ''}</td>
                            <td>
                                <a href="https://purles.pl/panel/orderd.php?idt=${payment.orderNumber}" target="_blank" class="order-link">#${payment.orderNumber}</a> (${payment.type})
                            </td>
                            <td>${formatDate(payment.dateBooked)}</td>
                            <td>${clientName}</td>
                            <td class="text-right">${payment.amount.toFixed(2)}</td>
                            <td class="text-right">-${payment.commission.toFixed(2)}</td>
                            <td class="text-right ${isFirstPayment && Math.abs(result.difference) > 0.01 ? (result.difference < 0 ? 'negative-discrepancy' : 'discrepancy') : ''}">${isFirstPayment ? result.difference.toFixed(2) : ''}</td>
                            <td>${isFirstPayment ? (result.issues.length > 0 ? result.issues.join('<br>') : '-') : ''}</td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                } else {
                    // Je≈õli brak zam√≥wie≈Ñ - wy≈õwietl wiersz z pustym polem zam√≥wie≈Ñ
                    const row = document.createElement('tr');
                    const statusClass = `status-${result.status}`;
                    
                    // Zaznacz ca≈Çy wiersz je≈õli ujemna r√≥≈ºnica
                    const isNegativeDiff = result.difference < -0.01;
                    if (isNegativeDiff) {
                        row.style.background = '#fff3cd';
                        row.style.fontWeight = 'bold';
                    }
                    
                    row.innerHTML = `
                        <td><span class="status-badge ${statusClass}">${result.status === 'ok' ? '‚úÖ OK' : result.status === 'warning' ? '‚ö†Ô∏è UWAGA' : '‚ùå B≈ÅƒÑD'}</span></td>
                        <td>${formatDate(result.payout.dateBooked)}</td>
                        <td>${result.payout.paymentId}</td>
                        <td class="text-right">${result.payout.amount.toFixed(2)}</td>
                        <td style="color: #999; font-style: italic;">Brak powiƒÖzanych zam√≥wie≈Ñ</td>
                        <td class="text-right">0.00</td>
                        <td class="text-right">0.00</td>
                        <td class="text-right ${Math.abs(result.difference) > 0.01 ? (result.difference < 0 ? 'negative-discrepancy' : 'discrepancy') : ''}">${result.difference.toFixed(2)}</td>
                        <td>${result.issues.length > 0 ? result.issues.join('<br>') : '-'}</td>
                    `;
                    
                    tbody.appendChild(row);
                }
            });

            // Poka≈º modal z podsumowaniem
            const hasDiscrepancies = issuesCount > 0;
            showSummaryModal(hasDiscrepancies, totalDifferences);

            // Podsumowanie
            summaryBox.innerHTML = `
                <div class="stat">
                    <div class="stat-label">Transze</div>
                    <div class="stat-value">${results.length}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Kwota transz NETTO (z≈Ç)</div>
                    <div class="stat-value">${totalPayouts.toFixed(2)}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Wp≈Çaty BRUTTO (z≈Ç)</div>
                    <div class="stat-value">${totalPaymentsBrutto.toFixed(2)}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Wp≈Çaty NETTO (z≈Ç)</div>
                    <div class="stat-value">${totalPaymentsNetto.toFixed(2)}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Razem prowizje (z≈Ç)</div>
                    <div class="stat-value">${(totalPaymentsBrutto - totalPaymentsNetto).toFixed(2)}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Razem r√≥≈ºnice (z≈Ç)</div>
                    <div class="stat-value">${totalDifferences.toFixed(2)}</div>
                </div>
            `;
        }

        // ===== ALERT =====
        function showAlert(title, message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.innerHTML = `<strong>${title}:</strong> ${message}`;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        // ===== EXPORT =====
        function exportToCSV() {
            const table = document.getElementById('resultsTable');
            const csv = [];
            
            // Nag≈Ç√≥wki
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => {
                headers.push('"' + th.textContent.trim().replace(/"/g, '""') + '"');
            });
            csv.push(headers.join(';'));

            // Dane
            table.querySelectorAll('tbody tr').forEach(tr => {
                const cells = [];
                tr.querySelectorAll('td').forEach((td, idx) => {
                    let text = td.textContent.trim();
                    text = text.replace(/(\d+)\.(\d+)/g, '$1,$2');
                    text = text.replace(/\n/g, ' ').replace(/\s+/g, ' ');
                    cells.push('"' + text.replace(/"/g, '""') + '"');
                });
                csv.push(cells.join(';'));
            });

            downloadFile(csv.join('\n'), 'idosell-mapowanie-' + new Date().toISOString().split('T')[0] + '.csv', 'text/csv;charset=utf-8');
        }

        function exportToODS() {
            const table = document.getElementById('resultsTable');
            const data = [];
            
            // Nag≈Ç√≥wki
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => {
                headers.push(th.textContent.trim());
            });
            data.push(headers);

            // Dane
            table.querySelectorAll('tbody tr').forEach(tr => {
                const cells = [];
                tr.querySelectorAll('td').forEach((td, idx) => {
                    let text = td.textContent.trim();
                    text = text.replace(/(\d+)\.(\d+)/g, '$1,$2');
                    text = text.replace(/\n/g, ' ').replace(/\s+/g, ' ');
                    cells.push(text);
                });
                data.push(cells);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Mapowanie');
            XLSX.writeFile(wb, 'idosell-mapowanie-' + new Date().toISOString().split('T')[0] + '.ods');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function printResults() {
            window.print();
        }

        // ===== UTILITY =====
        function formatDate(date) {
            if (!date) return '-';
            const d = new Date(date);
            return d.toLocaleDateString('pl-PL') + ' ' + d.toLocaleTimeString('pl-PL', {hour: '2-digit', minute: '2-digit'});
        }

        function clearAll() {
            document.getElementById('payoutFile').value = '';
            document.getElementById('blikFile').value = '';
            document.getElementById('paybyFile').value = '';
            document.getElementById('payoutFileName').textContent = '';
            document.getElementById('blikFileName').textContent = '';
            document.getElementById('paybyFileName').textContent = '';
            document.getElementById('alertContainer').innerHTML = '';
            document.getElementById('resultsSection').classList.remove('show');
            parsedData = { payouts: [], blik: [], payby: [] };
        }


        // ===== OBS≈ÅUGA MODALA =====
        function showSummaryModal(hasDiscrepancies, totalDifference) {
            const modal = document.getElementById('summaryModal');
            const icon = document.getElementById('modalIcon');
            const title = document.getElementById('modalTitle');
            const stats = document.getElementById('modalStats');
            const message = document.getElementById('modalMessage');
            
            if (hasDiscrepancies) {
                icon.innerHTML = '‚ö†Ô∏è';
                title.innerHTML = 'Znaleziono rozbie≈ºno≈õci!';
                message.innerHTML = `≈ÅƒÖczna r√≥≈ºnica: <strong>${totalDifference.toFixed(2)} z≈Ç</strong><br><br>Sprawd≈∫ szczeg√≥≈Çy poni≈ºej.`;
                icon.style.color = '#ff9800';
            } else {
                icon.innerHTML = '‚úÖ';
                title.innerHTML = 'Wszystko OK!';
                message.innerHTML = 'Wszystkie transze siƒô zgadzajƒÖ. Brak rozbie≈ºno≈õci.';
                icon.style.color = '#4CAF50';
            }
            
            let statsHtml = '<div class="modal-stat-item"><strong>Transze:</strong> ' + lastResults.length + '</div>';
            let totalPayouts = lastResults.reduce((s, r) => s + r.payout.amount, 0);
            let totalNetto = lastResults.reduce((s, r) => s + r.totalNetAmount, 0);
            statsHtml += '<div class="modal-stat-item"><strong>Kwota NETTO:</strong> ' + totalPayouts.toFixed(2).replace('.', ',') + ' z≈Ç</div>';
            statsHtml += '<div class="modal-stat-item"><strong>Wp≈Çaty NETTO:</strong> ' + totalNetto.toFixed(2).replace('.', ',') + ' z≈Ç</div>';
            statsHtml += '<div class="modal-stat-item"><strong>Razem rozbie≈ºno≈õci:</strong> ' + totalDifference.toFixed(2).replace('.', ',') + ' z≈Ç</div>';
            
            stats.innerHTML = statsHtml;
            modal.classList.add('show');
            
            setTimeout(() => closeSummaryModal(), 4000);
        }

        function closeSummaryModal() {
            const modal = document.getElementById('summaryModal');
            modal.classList.remove('show');
        }
    </script>
</body>
</html>
